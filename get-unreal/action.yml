
name: UEDownload

inputs:
  UnrealEnginePAT:
    required: true
    type: string
  UnrealStorageRoot:
    required: false
    type: string
    default: "C:"
    
runs:
  using: "composite"
  steps:
  
    - uses: actions/checkout@v3

   # - name: Setup tmate session
   #   uses: mxschmitt/action-tmate@v3
   #   with:
   #     detached: true
   #     sudo: false
      
    - name: Disk info
      shell: pwsh
      run: Get-PSDrive

    - name: Clone Unreal Engine
      shell: pwsh
      run: |
        cd ${{ inputs.UnrealStorageRoot }}/
        git clone https://${{ inputs.UnrealEnginePAT }}@github.com/EpicGames/UnrealEngine.git --depth 1 --branch 5.3
   
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    - name: Disk info after clone
      shell: pwsh
      run: Get-PSDrive
      
    #- name: Get cached engine
     # id: cached-engine
     # uses: actions/cache@v3
     # with:
     #   path: "${{ inputs.UnrealStorageRoot }}/UnrealEngine"
     #   key: "CachedEngine"

    #- name: SymLink Unreal Engine clone directory
     # shell: pwsh
      #run: New-Item -Path ./UnrealEngine -ItemType SymbolicLink -Value C:/UnrealEngine

    #- name: Checkout Unreal
     # uses: actions/checkout@v3
      #if: ${{ !steps.cached-engine.outputs.cache-hit }}
     # with:
      #  repository: EpicGames/UnrealEngine
       # token: 
        #path: ${{ inputs.UnrealStorageRoot }}/UnrealEngine
        #fetch-depth: 1
        #ref: "5.0.3-release"

    - name: copy gitdepsignore file
      shell: pwsh
      run: |
        Copy-Item -Path "./get-unreal/.gitdepsignore" -Destination ${{ inputs.UnrealStorageRoot }}/UnrealEngine -Force 

    - name: Download Unreal Engine dependencies
      shell: pwsh
      run: |
        cd ${{ inputs.UnrealStorageRoot }}/UnrealEngine
        dir
        # Older versions use another path for gitdependencies
        .\Engine\Binaries\DotNET\GitDependencies\win-x64\GitDependencies.exe --cache=C:\GitDeps
        ./GenerateProjectFiles.bat
        
    - name: Remove unnecessary plugins
      shell: pwsh
      run: |
        $requiredPlugins = @( 
            "Messaging"
        );
        
        ./scripts/RemoveChildDirsExcept.ps1 "${{ inputs.UnrealStorageRoot }}/UnrealEngine/Engine/Plugins" @("Messaging")

    - name: Disk info after dependencies
      shell: pwsh
      run: Get-PSDrive
   
    - uses: actions/setup-python@v4
      with:
        python-version: '3.x'          

    - name: Install ue4cli
      shell: pwsh
      run: pip install ue4cli

    - name: Set root ue4cli
      shell: pwsh
      run: ue4 setroot "${{ inputs.UnrealStorageRoot }}/UnrealEngine"
      
    - uses: nick-fields/retry@v2
      name: Build Engine
      with:
        timeout_minutes: 360
        max_attempts: 3 # retry a few times due to occasional heap memory exhaustion
        shell: pwsh
        command: ue4 build-target UnrealEditor Development -DisableUnity #-NoPCH -NoSharedPCH 
    
    - name: Disk info 2
      shell: pwsh
      run: Get-PSDrive
